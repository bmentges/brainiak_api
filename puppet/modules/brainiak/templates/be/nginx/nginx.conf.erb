##########################################################################
# ARQUIVO GERENCIADO PELO PUPPET                                         #
# AS ALTERACOES MANUAIS SERAO REMOVIDAS NA PROXIMA ATUALIZACAO DO PUPPET #
##########################################################################
# ['local do Template':'local de instalacao']
# [puppet/modules/<%=projeto%>/templates/<%=self.name%>]

worker_processes <%=scope.lookupvar('infra::nginx::vars::nginx_num_workers')%>;
pid <%=pid_file%>;

syslog local6 <%=servico%>;
error_log syslog:error|<%=error_log_file%> error;

events {
    worker_connections  2048;
    use epoll;
}

http {

    # Customizado
    include mime.types;

    default_type application/octet-stream;

    log_subrequest on;
    log_format main '$remote_addr - $remote_user [$time_local] $host "$request" '
                    '$status $body_bytes_sent "$http_referer" "$http_user_agent" "$http_x_forwarded_for" '
                    'request_time[$request_time] Proxy_subrequest[$proxy_host$uri$is_args$args] '
                    'Proxy: $upstream_cache_status $upstream_status $upstream_response_time'
                    'Cache-Control: $upstream_http_cache_control '
                    'Expires: $upstream_http_expires $request_length';

    log_format syslog '$remote_addr - $remote_user $host "$request" '
                      '$status $body_bytes_sent "$http_referer" "$http_user_agent" "$http_x_forwarded_for" '
                      'request_time[$request_time] Proxy_subrequest[$proxy_host$uri$is_args$args] '
                      'Proxy: $upstream_cache_status $upstream_status $upstream_response_time'
                      'Cache-Control: $upstream_http_cache_control '
                      'Expires: $upstream_http_expires $request_length';

    access_log <%=access_log_file%>  main;
    access_log syslog:notice syslog;

    ssi on;
    sendfile on;
    keepalive_timeout 15;
    server_tokens off;
    port_in_redirect off;
    merge_slashes off;

    tcp_nopush on;
    tcp_nodelay on;

    client_header_buffer_size 6k;
    large_client_header_buffers 6 6k;
    client_max_body_size 20m;
    client_body_temp_path       <%=clientbody_temp_dir%> 2 2;

    proxy_temp_path             <%=proxytemp_dir%> 2 2;
    proxy_cache_path            <%=instancia_cache_dir%>  levels=2:2  keys_zone=<%=cache_zone_name%>:<%=scope.lookupvar('infra::nginx::vars::nginx_cache_keys_zone')%>  max_size=<%=scope.lookupvar('infra::nginx::vars::nginx_cache_max_size')%> inactive=7d;
    proxy_cache_key             "$uri$is_args$args";
    proxy_cache_valid           200 302 1m;
    proxy_cache_use_stale       error timeout updating invalid_header http_500 http_502 http_503 http_504;
    proxy_redirect              off;
    proxy_set_header            Host $host;
    proxy_set_header            X-Real-IP $remote_addr;
    proxy_set_header            X-Scheme $scheme;
    proxy_set_header            X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_ignore_headers        "Set-Cookie";
    proxy_connect_timeout       2s;
    proxy_read_timeout          20s;
    proxy_send_timeout          10s;
    proxy_intercept_errors      on;
    proxy_ignore_client_abort   on;
    proxy_http_version          1.1;
    proxy_set_header Connection "";

    server {

        listen *:<%=scope.lookupvar('brainiak::params::nginx_bind_port')%>;

        server_name <%=scope.lookupvar('brainiak::params::projeto_host')%>;

        # Doc
        location /docs {
            alias <%=scope.lookupvar('brainiak::params::projeto_deploybe_dir')%>/app/current/docs;
        }

        # Rotas din√¢micas
        location / {
            proxy_pass  http://localhost:8090;
            proxy_cache <%=cache_zone_name%>;
        }

    }

    # Virtual host para negar requisicao
    server {

        listen  *:<%=scope.lookupvar('brainiak::params::nginx_bind_port')%> default_server;

        # Allowed HTTP Methods
        if ($request_method !~ "(GET|HEAD|POST)") {
            return 405;
        }

        location / {
            return 404;
        }

    }

}
# EOF
